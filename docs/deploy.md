# Deployment of Bot

## Prerequisite

1. [Azure Subscription](https://azure.microsoft.com/en-in)
1. [Microsoft 365 tenant with Teams enabled](https://docs.microsoft.com/en-us/microsoftteams/platform/concepts/build-and-test/prepare-your-o365-tenant)
1. [Azure Virtual Machine - Windows - 4vCPU x 16Gib Memory recommended](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal)
1. [Azure App Service Domain](https://docs.microsoft.com/en-us/azure/app-service/manage-custom-dns-buy-domain#buy-an-app-service-domain)
1. [Azure Cognitive Speech services](https://azure.microsoft.com/en-in/services/cognitive-services/speech-services/)
1. A Development Environment (Windows 10)

## Deployment

### [Letsencrypt](https://letsencrypt.org) Certificate for App Service Domain

1. Install [certbot](https://certbot.eff.org) and [openssl](https://www.openssl.org) in local Development Environment
1. Execute `certbot certonly --manual --preferred-challenges dns -d \*.<domain_name>` to create certificate
1. This above command will ask to create a `DNS TXT record under the name`, copy the TXT value (do not press enter)
1. In App Service Domain [Create a TXT record](https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-custom-domain#create-the-cname-record) by specifying -
    1. `Name` as `_acme-challenge`
    1. `Type` as `TXT`
    1. `TTL` as `3600`
    1. `Value` as copied TXT value from Terminal
1. Go to Terminal where `certbot` command was getting executed, press enter, certificate created successfully, note the path where the certificate files are present
1. Execute `openssl pkcs12 -export -out <certificate_name>.pfx -inkey <path_to_cert_files>/privkey.pem -in <path_to_cert_files>/cert.pem` to create a `PKCS#12` format certificate, so that it can be imported in Windows

### Configure Windows Virtual Machine (VM)

1. [Associate a public IP address to VM](https://docs.microsoft.com/en-us/azure/virtual-network/associate-public-ip-address-vm)
1. [Allow](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/nsg-quickstart-portal) following inbound ports -
    1. TCP: `80`, `443`
    1. Any: `8081`, `9441`, `8172`
1. [Create a CNAME record](https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-custom-domain#create-the-cname-record) and Add public IP address of VM -
    1. `Name` as `bot` - any other name can be given
    1. `Type` as `CNAME`
    1. `TTL` as `3600`
    1. `Value` as Public IP address of the VM
1. Download [nginx](http://nginx.org/en/download.html) and extract into a directory (Ex. `C:\nginx`)
1. Copy the certificates (`privkey.pem` and `cert.pem` created in previous step by `certbot` command) into `C:\nginx\conf` directory
1. Modify the content of `C:\nginx\conf\nginx.conf` of `http` section and add `stream` section as per following reference -

    ```conf
    http {
        include       mime.types;
        default_type  application/octet-stream;

        sendfile        on;
        keepalive_timeout  65;
    
        server {
            listen       443 ssl;
            server_name  localhost;
    
            ssl_certificate      cert.pem;
            ssl_certificate_key  privkey.pem;
    
            ssl_session_cache    shared:SSL:1m;
            ssl_session_timeout  5m;
    
            ssl_ciphers  HIGH:!aNULL:!MD5;
            ssl_prefer_server_ciphers  on;
    
            location / {
                    proxy_pass  https://127.0.0.1:9441;
            }
        }
    }
    
    stream {
        upstream tcp_backend {
            server 127.0.0.1:8445;
        }
        server {
            listen 8081;
            proxy_pass tcp_backend ;
        }
    }
    ```

1. Cope `<certificate_name>.pfx` the `PKCS#12` format certificate generated by `openssl` in to VM and double click to import for all user
1. Start nginx - execute `C:\nginx\nginx.exe`
1. [Downloads](https://dotnet.microsoft.com/download) and install .NET Framework and .NET Core
1. Execute - `dotnet dev-certs https --trust` to trust the certificate for localhost

### Create Teams Bot

1. [Registering a calling bot](https://microsoftgraph.github.io/microsoft-graph-comms-samples/docs/articles/calls/register-calling-bot.html)
1. Configure your permissions. Go to Settings page and click on the Manage link near Microsoft App ID. In the new page, click Add button after Application Permissions and select Calls.AccessMedia.All, and then save the change. If your bot also need to join meeting, select Calls.JoinGroupCall.All as well.
1. The permission needs to be consented by tenant admin. Go to [https://login.microsoftonline.com/common/adminconsent?client_id=<app_id>&state=<any_number>&redirect_uri=<callback_url](https://login.microsoftonline.com/common/adminconsent?client_id=<app_id>&state=<any_number>&redirect_uri=<callback_url) using tenant admin to sign-in, then consent for the whole tenant. - [reference](https://github.com/microsoftgraph/microsoft-graph-comms-samples/tree/master/Samples/V1.0Samples/LocalMediaSamples#getting-started)

### Azure Cognitive Speech services Configuration

1. Get Subscription Key for [Text-to-speech REST API](https://docs.microsoft.com/en-us/azure/cognitive-services/speech-service/rest-text-to-speech)

### Deploy Teams Bot in Windows Virtual Machine

1. Publish the Bot code into VM (Ex. `C:\BOT_FTP_PUBLISH`)
1. Modify `C:\BOT_FTP_PUBLISH\appsettings.json` with following content -

    ```json
    {
      "AllowedHosts": "*",
      "AzureSettings": {
        "BotName": "<Bot Name, created while Registering a calling bot>",
        "AadAppId": "<Application Id of the Bot, , created while Registering a calling bot>",
        "AadAppSecret": "<Application Secret of the Bot, created while Registering a calling bot>",
        "ServiceCname": "<DNS Name of the VM, ex. bot.domain_name>",
        "MediaServiceFQDN": "<DNS Name of the VM, ex. bot.domain_name>",
        "ServiceDnsName": "<DNS Name of the VM, ex. bot.domain_name>",
        "CertificateThumbprint": "<Thumb print of the certificate created for the domain_name>",
        "InstancePublicPort": 8081,
        "CallSignalingPort": 9441,
        "InstanceInternalPort": 8445,
        "PlaceCallEndpointUrl": "https://graph.microsoft.com/v1.0",
        "SpeechSubscriptionKey": "<Subscription Key for Azure Cognitive Speech services>",
        "SpeechRegion": "centralindia",
        "SpeechSynthesisVoiceName": "en-IN-NeerjaNeural"
      }
    }
    ```

    NOTE: [Guide](https://knowledge.digicert.com/solution/SO9840.html) to get Thump print of a certificate

1. Start the Bot Process, by executing - `C:\BOT_FTP_PUBLISH\AI4Bharat.ISLBot.Services.exe`

## Testing

Sanity Testing of the deployed Bot

1. Make sure there are no errors from any of the above steps :smile:
1. Follow the [microsoft-graph-comms-samples testing guide](https://github.com/microsoftgraph/microsoft-graph-comms-samples/tree/master/Samples/V1.0Samples/LocalMediaSamples/AudioVideoPlaybackBot#test) to start a meeting and join the Bot into the call
